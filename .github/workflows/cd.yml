name: CD - Deploy Iris API to GKE

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Authenticate with GCP
      - name: Authenticate to Google Cloud
        env:
          GCP_B64: ${{ secrets.GCP_KEY_JSON }}
        run: |
          set -e
          echo "$GCP_B64" | base64 -d > gcp-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcp-key.json" >> $GITHUB_ENV
          export GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcp-key.json
          
          echo "✓ Decoded service account key"
          python3 -m json.tool gcp-key.json > /dev/null && echo "✓ Valid JSON"
          echo "Installing Google Cloud CLI..."
          sudo apt-get update && sudo apt-get install -y google-cloud-cli
          
          echo "Authenticating with GCP..."
          gcloud auth activate-service-account --key-file=gcp-key.json
          
          # Set up application default credentials correctly
          echo "Setting up application default credentials..."
          gcloud auth application-default print-access-token > /dev/null 2>&1 || \
          GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcp-key.json gcloud auth application-default login --no-launch-browser --quiet || true

      # 3. Setup gcloud CLI
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: logical-river-338214
          install_components: 'kubectl'
      - name: Download model from GCS
        run: |
          gsutil cp gs://mlops-course-803234401672-week1/my-models/iris-classifier-week-1/model.joblib ./model.joblib
      # 4. Configure Docker to use Artifact Registry
      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      # 5. Build and push Docker image
      - name: Build and push Docker image
        run: |
          IMAGE=us-central1-docker.pkg.dev/logical-river-338214/my-repo/iris-api:latest
          docker build -t $IMAGE .
          docker push $IMAGE
      # 6. Get GKE credentials
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials gke-cluster-k8s-mlops --zone us-central1 --project logical-river-338214
      - name: Verify GKE cluster access
        run: |
          kubectl cluster-info
          kubectl get nodes
      # 7. Deploy to Kubernetes
      - name: Deploy to GKE
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
      - name: Wait for external IP
        run: |
          kubectl get svc model-deployment-mlops-workload-service --watch
